<?php

//////////////////////////////////////////////////////////////////////////////80
// Active Class
//////////////////////////////////////////////////////////////////////////////80
// Copyright (c) Atheos & Liam Siira (Atheos.io), distributed as-is and without
// warranty under the modified License: MIT - Hippocratic 1.2: firstdonoharm.dev
// See [root]/license.md for more. This information must remain intact.
//////////////////////////////////////////////////////////////////////////////80
// Authors: Codiad Team, @Fluidbyte, Atheos Team, @hlsiira
//////////////////////////////////////////////////////////////////////////////80

class Active {

	//////////////////////////////////////////////////////////////////////////80
	// PROPERTIES
	//////////////////////////////////////////////////////////////////////////80

	private $db = null;

	//////////////////////////////////////////////////////////////////////////80
	// METHODS
	//////////////////////////////////////////////////////////////////////////80

	// -----------------------------||----------------------------- //

	//////////////////////////////////////////////////////////////////////////80
	// Construct
	//////////////////////////////////////////////////////////////////////////80
	public function __construct() {
		$this->db = Common::getDB("active");
	}

	//////////////////////////////////////////////////////////////////////////80
	// Add File
	//////////////////////////////////////////////////////////////////////////80
	public function add($activeUser, $path) {
		$query = array("user" => $activeUser, "path" => $path, "status" => "active");
		$this->db->insert($query);
		Common::sendJSON("S2000");
	}

	//////////////////////////////////////////////////////////////////////////80
	// Check File
	//////////////////////////////////////////////////////////////////////////80
	public function check($activeUser, $path) {
		$where = array("user" => "*", "path" => $path);
		$result = $this->db->select($where);
		if (count($result) > 1) {
			$activeUsers = array();
			foreach ($result as $item) {
				if ($item["user"] !== $activeUser) $activeUsers[] = $item["user"];
			}
			Common::sendJSON("warning", i18n("warning_fileOpen", implode(", ", $activeUsers)));
		} else {
			Common::sendJSON("S2000");
		}
	}

	//////////////////////////////////////////////////////////////////////////80
	// List User's Active Files
	//////////////////////////////////////////////////////////////////////////80
	public function listActive($activeUser) {
		$where = array("user" => $activeUser);
		$result = $this->db->select($where);
		Common::sendJSON("S2000", $result);
	}

	//////////////////////////////////////////////////////////////////////////80
	// Rename File
	//////////////////////////////////////////////////////////////////////////80
	public function rename($oldPath, $newPath) {
		$where = array("user" => $activeUser, "path" => $oldPath);
		$value = array("path" => $newPath);
		$this->db->update($where, $value);
		Common::sendJSON("S2000");
	}

	//////////////////////////////////////////////////////////////////////////80
	// Remove File
	//////////////////////////////////////////////////////////////////////////80
	public function remove($activeUser, $path) {
		$where = array("user" => $activeUser, "path" => $path);
		$this->db->delete($where);
		Common::sendJSON("S2000");
	}

	//////////////////////////////////////////////////////////////////////////80
	// Remove All Files
	//////////////////////////////////////////////////////////////////////////80
	public function removeAll($activeUser) {
		$where = array("user" => $activeUser);
		$this->db->delete($where);
		Common::sendJSON("S2000");
	}

	//////////////////////////////////////////////////////////////////////////80
	// Mark File As Focused
	//  All other files will be marked as non-focused.
	//////////////////////////////////////////////////////////////////////////80
	public function setFocus($activeUser, $focus) {
		$where = array("user" => $activeUser, "path" => "*");
		$value = array("status" => "active");
		$this->db->update($where, $value);

		$where = array("user" => $activeUser, "path" => $path);
		$value = array("status" => "focus");
		$this->db->update($where, $value);
		Common::sendJSON("S2000");
	}
}