<?php

/*
*  Copyright (c) Codiad & daeks (codiad.com), distributed
*  as-is and without warranty under the MIT License. See
*  [root]/license.txt for more. This information must remain intact.
*/

class Update
{

	//////////////////////////////////////////////////////////////////
	// PROPERTIES
	//////////////////////////////////////////////////////////////////

    public $remote = "";
    public $commits = "";
    public $archive = "";

	//////////////////////////////////////////////////////////////////
	// METHODS
	//////////////////////////////////////////////////////////////////

	// -----------------------------||----------------------------- //

	//////////////////////////////////////////////////////////////////
	// Construct
	//////////////////////////////////////////////////////////////////

	public function __construct() {
		ini_set("user_agent", "Atheos");
	}

	//////////////////////////////////////////////////////////////////
	// Set Initial Version
	//////////////////////////////////////////////////////////////////

	public function init() {
		$version = array();
		if (file_exists(DATA ."/version.json")) {
			$local = $this->getLocalData();

			echo json_encode(array(
				"local" => $local,
				"php_version" => phpversion(),
				"server_operating_system" => $_SERVER['SERVER_SOFTWARE'],
				"language" => LANGUAGE,
				"location" => $_SERVER['SERVER_ADDR'],
				"plugins" => Common::readDirectory(PLUGINS),
			));
		}
	}
	//////////////////////////////////////////////////////////////////
	// Check Latest Version
	//////////////////////////////////////////////////////////////////

	public function check() {
		$local = $this->getLocalData();
		$remote = $this->getRemoteVersion();

		return json_encode(array(
			"local" => $local,
			"remote" => $remote,
		));
	}

	//////////////////////////////////////////////////////////////////
	// Get Remote Version
	//////////////////////////////////////////////////////////////////

	public function getRemoteVersion() {
		$remoteurl = Common::getConstant('UPDATEURL', $this->remote);
		return json_decode(file_get_contents($remoteurl), true);
	}

	//////////////////////////////////////////////////////////////////
	// Get Local Data
	//////////////////////////////////////////////////////////////////

	public function getLocalData() {
		if (file_exists(DATA."/version.json")) {
			$data = getJSON("/version.json");
		}
		return $data;
	}

	//////////////////////////////////////////////////////////////////
	// Save Local Data
	//////////////////////////////////////////////////////////////////

	public function setLocalData() {
		$current = getJSON('version.json');
		$data = json_decode(file_get_contents("php://input"));
		saveJSON('version.json', $current);
	}
	//////////////////////////////////////////////////////////////////
	// OptOut
	//////////////////////////////////////////////////////////////////

	public function optOut() {
		$current = getJSON('version.json');
		$current['optOut'] = false;
		saveJSON('version.json', $current);
	}
	//////////////////////////////////////////////////////////////////
	// OptIn
	//////////////////////////////////////////////////////////////////

	public function optIn() {
		$current = getJSON('version.json');
		$current['optOut'] = true;
		saveJSON('version.json', $current);
	}
}