<?php

//////////////////////////////////////////////////////////////////////////////80
// Update Class
//////////////////////////////////////////////////////////////////////////////80
// Copyright (c) Atheos & Liam Siira (Atheos.io), distributed as-is and without
// warranty under the modified License: MIT - Hippocratic 1.2: firstdonoharm.dev
// See [root]/license.md for more. This information must remain intact.
//////////////////////////////////////////////////////////////////////////////80
// Authors: Codiad Team, @Fluidbyte, Atheos Team, @hlsiira
//////////////////////////////////////////////////////////////////////////////80

class Update {

	//////////////////////////////////////////////////////////////////////////80
	// PROPERTIES
	//////////////////////////////////////////////////////////////////////////80

	private $update = 'https://www.atheos.io/update';
	private $github = 'https://api.github.com/repos/Atheos/Atheos/releases/latest';


	//////////////////////////////////////////////////////////////////////////80
	// METHODS
	//////////////////////////////////////////////////////////////////////////80

	// ----------------------------------||---------------------------------- //

	//////////////////////////////////////////////////////////////////////////80
	// Construct
	//////////////////////////////////////////////////////////////////////////80
	public function __construct() {
		ini_set("user_agent", "Atheos");
		$this->version = Common::readJSON('version');
	}

	//////////////////////////////////////////////////////////////////////////80
	// Set Initial Version
	//////////////////////////////////////////////////////////////////////////80
	public function init() {
		$version = array();
		if (file_exists(DATA ."/version.json")) {
			$local = $this->getLocalData();

			$local["last_heard"] = date("Y/m/d");
			$local["php_version"] = phpversion();
			$local["server_os"] = Common::data("SERVER_SOFTWARE", "server");
			$local["client_os"] = $this->getBrowserName();
			$local["language"] = LANGUAGE;
			$local["location"] = LANGUAGE;
			$local["plugins"] = PLUGINS;


			$reply = array(
				"local" => $local,
				"remote" => defined('UPDATEURL') ? UPDATEURL : $this->update,
				"github" => defined('GITHUBAPI') ? GITHUBAPI : $this->github
			);

			Common::sendJSON("success", $reply);

		}
	}

	//////////////////////////////////////////////////////////////////////////80
	// Check Latest Version
	//////////////////////////////////////////////////////////////////////////80
	public function check() {
		$local = $this->getLocalData();

		return json_encode(array(
			"local" => $local
		));
	}

	//////////////////////////////////////////////////////////////////////////80
	// Get Local Data
	//////////////////////////////////////////////////////////////////////////80
	public function getLocalData() {
		$current = Common::readJSON('version');
		return $current;
	}

	//////////////////////////////////////////////////////////////////////////80
	// Save Local Data
	//////////////////////////////////////////////////////////////////////////80
	public function setLocalData() {
		$current = Common::readJSON('version');
		Common::saveJSON('version', $current);
	}
	//////////////////////////////////////////////////////////////////////////80
	// OptOut
	//////////////////////////////////////////////////////////////////////////80
	public function optOut() {
		$current = Common::readJSON('version');
		$current['optOut'] = false;
		Common::saveJSON('version', $current);
	}
	//////////////////////////////////////////////////////////////////////////80
	// OptIn
	//////////////////////////////////////////////////////////////////////////80
	public function optIn() {
		$current = Common::readJSON('version');
		$current['optOut'] = true;
		Common::saveJSON('version', $current);
	}

	//////////////////////////////////////////////////////////////////////////80
	// GetBrowserName
	//////////////////////////////////////////////////////////////////////////80
	public function getBrowserName() {
		$userAgent = Common::data("HTTP_USER_AGENT", "server");
		if (strpos($userAgent, 'Opera') || strpos($userAgent, 'OPR/')) return 'Opera';
		elseif (strpos($userAgent, 'Edge')) return 'Edge';
		elseif (strpos($userAgent, 'Chrome')) return 'Chrome';
		elseif (strpos($userAgent, 'Safari')) return 'Safari';
		elseif (strpos($userAgent, 'Firefox')) return 'Firefox';
		elseif (strpos($userAgent, 'MSIE') || strpos($userAgent, 'Trident/7')) return 'Internet Explorer';

		return 'Other';
	}
}